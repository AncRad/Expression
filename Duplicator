@name Duplicator

@inputs 
@outputs 
@persist [E O]:entity [Duplicator]:table [GDuplicator GLibrary]:gtable



if(changed(0)) {
    runOnFile(1)
    runOnChat(1)
    runOnHTTP(1)
    timer("fileSistem", 1)
    timer("printSistem", 1)
    timer("updaterSistem", 1)
    
    Duplicator["updaterSistem/request/maxTime", number] = 20
    Duplicator["updaterSistem/wait/maxTime", number] = 20
    Duplicator["fileSistem/write/maxTime", number] = 20
    Duplicator["fileSistem/load/maxTime", number] = 20
    
    E = entity()
    O = owner()
    
    function addPrint(Print:array) {
        Duplicator["printSistem/print", array] = Duplicator["printSistem/print", array]:add(array(vec(255)):add(Print))
    }
    function addPrint(Print:string) {
        addPrint(array(Print))
    }
    function addPrint(Color:vector, Print:string) {
        addPrint(array(Color, Print))
    }
    #
    #
    #
    function addPrintBlue(Print:array) {
        Print = array(vec(150,150,255)):add(Print:add(array(vec(255))))
        Duplicator["printSistem/print", array] = Duplicator["printSistem/print", array]:add(Print)
    }
    function addPrintBlue(Print:string) {
        addPrintBlue(array(Print))
    }
    #
    function addPrintValue(Print:array) {
        Print = array(vec(255,120,120)):add(Print:add(array(vec(255))))
        Duplicator["printSistem/print", array] = Duplicator["printSistem/print", array]:add(Print)
    }
    function addPrintValue(Print:string) {
        addPrintValue(array(Print))
    }
    #
    function addPrintRed(Print:array) {
        Print = array(vec(255,60,60)):add(Print:add(array(vec(255))))
        Duplicator["printSistem/print", array] = Duplicator["printSistem/print", array]:add(Print)
    }
    function addPrintRed(Print:string) {
        addPrintRed(array(Print))
    }
    #
    function addPrintGreen(Print:array) {
        Print = array(vec(60,255,60)):add(Print:add(array(vec(255))))
        Duplicator["printSistem/print", array] = Duplicator["printSistem/print", array]:add(Print)
    }
    function addPrintGreen(Print:string) {
        addPrintGreen(array(Print))
    }
    #
    #
    #
    function addPrintDuplicator(Print:array) {
        Print = array(vec(30,255,30),(Duplicator["printSistem/print", array]:count() ? "\n" : "") + "[Дубликатор] ",vec(255)):add(Print)
        Duplicator["printSistem/print", array] = Duplicator["printSistem/print", array]:add(Print)
    }
    function addPrintDuplicator(Print:string) {
        addPrintDuplicator(array(Print))
    }
    #
    function addPrintUpdater(Print:array) {
        addPrintDuplicator("")
        addPrintBlue("[Система обновления] ")
        Duplicator["printSistem/print", array] = Duplicator["printSistem/print", array]:add(Print)
    }
    function addPrintUpdater(Print:string) {
        addPrintUpdater(array(Print))
    }
    #
    function addPrintLibrary(Print:array) {
        addPrintDuplicator("")
        addPrintBlue("[Библиотека] ")
        Duplicator["printSistem/print", array] = Duplicator["printSistem/print", array]:add(Print)
    }
    function addPrintLibrary(Print:string) {
        addPrintLibrary(array(Print))
    }
    #
    function addPrintFile(Print:array) {
        addPrintDuplicator("")
        addPrintBlue("[Файловая система] ")
        Duplicator["printSistem/print", array] = Duplicator["printSistem/print", array]:add(Print)
    }
    function addPrintFile(Print:string) {
        addPrintFile(array(Print))
    }
    #
    #
    #
    function addPrintRemoteSetCode() {
        addPrint(vec(160,160,240), "entity")
        addPrint(vec(224,224,224), ":")
        addPrint(vec(160,160,240), "remoteSetCode")
        addPrint(vec(224,224,224), "(")
        addPrint(vec(160,160,240), "string")
        addPrint(vec(224,224,224), ")")
    }
    ################
    #
    #
    #
    ################
    function libraryGenerate(Library_n:string) {
        local UTC = dateUTC()
        
        GLibrary:clear()
        GLibrary["library/name", string] = Library_n
        GLibrary["creator/name", string] = O:name()
        GLibrary["creator/steamID", string] = O:steamID()
        GLibrary["creator/dateUTC", table] = UTC
        
        #GLibrary["history", table] = table("1" = table("dateUTC" = UTC, "operation" = "libraryCreate", "autor/name" = O:name(), "creator/steamID" = O:steamID()))
        
        
    }
    GDuplicator = gTable("Duplicator" + O:steamID())
    GLibrary = gTable("DuplicatorLibrary" + O:steamID())
    local Entity = GDuplicator["entity", entity]
    if(Entity == E | !Entity) {
        addPrint(vec(0), "========================================")
        if(GDuplicator["updateUploadCode", number] & Entity) {
            addPrintUpdater("Код был заменён на последнюю версию и ")
            addPrintGreen("успешно")
            addPrint(" запущен, чип готов к работе.")
            addPrintUpdater("Не забудьте открыть чип и сохранить последнюю версию кода.")
            addPrintDuplicator("Спасибо за то, что вы с нами :>")
            GLibrary:clear()
        }
        else {
            addPrintDuplicator("")
            addPrint("Код был запущен ")
            addPrintGreen("успешно")
            addPrint(", чип готов к работе.")
        }
        GDuplicator["updateUploadCode", number] = 0
        GDuplicator["entity", entity] = E
    }
    else {
        if(Entity:type() == "gmod_wire_expression2") {
            if(Entity:getName():explode("\n")[1, string] == "Duplicator") {
                    printColor(
                        vec( 30,255, 30), "[Дубликатор] ",
                        vec(255, 60, 60), "Обнаружена ошибка! ",
                        vec(255,255,255), "Указана причина: у вас уже существует чип \"Duplicator\".",
                        "\nЭтот чип будет уничтожен, пользуйтесь уже существующим, второй вам ни к чему."                        
                    )
                selfDestruct()
            }
        }
    }
    #
    #
    #
}


if(chatClk(O)) {
    if(changed(0)) {
        function addChatCommand(Command:string, Description:array) {
            Duplicator["commadSistem/" + Command, number] = 1
            Duplicator["commadSistem/" + Command + "/description", array] = Description
            Duplicator["commadSistem/list", array] = Duplicator["commadSistem/list", array]:add(array(Command))
        }
        
        addChatCommand(
            "команды",
            array(
                vec(255,255,255), "Печатает в чат список загруженных команд."
            )
        )
        addChatCommand(
            "проверить обновления",
            array(
                vec(255,255,255), "Отправляет запрос на загрузку страницы с последней оригинальной версией кода. Если страница будет загружена, то вы сможете воспользоваться командой \"",
                vec(150,150,255), "!обновить",
                vec(255,255,255), "\""
            )
        )
        addChatCommand(
            "обновить",
            array(
                vec(255,255,255), "Заменяет код чипа на код, который был загружен с сервера gitHub."
            )
        )
        #
        #- 
        #
        #[
        addChatCommand(
            "выделить",
            array(
                vec(255,255,255), "Определяет позицию выделения."
            )
        )
        addChatCommand(
            "радиус",
            array(
                vec(255,255,255), "Определяет радиус сферического выделения."
            )
        )
        addChatCommand(
            "сканировать",
            array(
                vec(255,255,255), "Сканирует выделенную область."
            )
        )
        addChatCommand(
            "добавить чертеж",
            array(
                vec(255,255,255), "Добавляет чертёж в библиотеку."
            )
        )
        ]#
        #
        #- 
        #
        addChatCommand(
            "создать библиотеку",
            array(
                vec(255,255,255), "Создаёт новую библиотеку."
            )
        )
        addChatCommand(
            "сохранить",
            array(
                vec(255,255,255), "Сохраняет отсканированное."
            )
        )
        addChatCommand(
            "загрузить",
            array(
                vec(255,255,255), "Загружает сохранённое."
            )
        )
        addChatCommand(
            "прервать",
            array(
                vec(255,255,255), "Прерывает указанную процедуру."
            )
        )
    }
    
    local LastSaid = O:lastSaid()
    if(LastSaid:left(1) == "!") {
        hideChat(1)
        
        local Explode = LastSaid:sub(2):explode(" ")
        local Command = Explode[1, string]
        
        switch(Command) {
            #
            #
            #
            case "команды",
                local CommandList = Duplicator["commadSistem/list", array]
                addPrintDuplicator("Список команд(")
                addPrintValue(CommandList:count() + "")
                addPrint("):")
                foreach(C, Command:string = CommandList) {
                    addPrintValue("\n" + C)
                    addPrint(". \"")
                    addPrintBlue("!" + Command)
                    addPrint("\" ")
                    addPrint(Duplicator["commadSistem/" + Command + "/description", array])
                }
            break
            #
            #
            #
            case "проверить",
                switch(Explode[2, string]) {
                    case "обновления",
                        addPrintUpdater("Начинаю поиск обновлений")
                        Duplicator["updaterSistem/procedure", string] = "request"
                    break
                    #
                    #
                    default,
                        addPrintDuplicator("Проверить что?")
                    break
                }
            break
            #
            #
            #
            case "обновить",
                local Update = Duplicator["updaterSistem/update", string]
                if(Update) {
                    #ifdef entity:remoteSetCode(string)
                        addPrintUpdater("Код чипа будет заменён на новый, чип будет перезапущен. После перезапуска откройте чип и сохраните новый код.")
                        GDuplicator["updateUploadCode", number] = 1
                        entity():remoteSetCode(Update)
                    #else
                        addPrintUpdater("")
                        addPrintRed("Ошибка обновления! ")
                        addPrint("Указана причина: отсутствует функция ")
                        addPrintRemoteSetCode()
                        addPrintUpdater("Вы можете загрузить файл самостоятельно, перейдя по ссылке ")
                        addPrintValue(Duplicator["updaterSistem/url", string])
                    #endif
                }
                else {
                    addPrintUpdater("")
                    addPrintRed("Ошибка обновления! ")
                    addPrint("Указана причина: отсутствует файл обновления")
                }
            break
            ################
            #
            #
            #
            ################
            case "создать",
                switch(Explode[2, string]) {
                    case "библиотеку",
                        local Library_n = Explode:concat(" ", 3)
                        if(Library_n) {
                            addPrintLibrary("Библиотека \"")
                            addPrintValue(Library_n)
                            addPrint("\" сгенерирована. Не забудьте сохранить.")
                            
                            libraryGenerate(Library_n)
                            
                        }
                        else {
                            addPrintDuplicator("")
                            addPrintRed("Ошибка создания библиотеки. ")
                            addPrint("Указана причина: не указано название библиотеки.")
                        }
                    break
                    #
                    #
                    default,
                        addPrintDuplicator("Создать что?")
                    break
                }
            break
            #
            #
            #
            case "сохранить",
                switch(Explode[2, string]) {
                    case "библиотеку",
                        local Library_n = GLibrary["library/name", string]
                        if(Library_n) {
                            if(Explode:concat(" ", 3,4) == "в чип") {
                                    local E2 = O:aimEntity()
                                    if(E2:type() == "gmod_wire_expression2") {
                                        #ifdef entity:remoteSetCode(string)
                                            if(E2:owner() == O) {
                                                if(E2 == E) {
                                                    addPrintDuplicator("")
                                                    addPrintRed("Ошибка сохранения библиотеки путём замены кода чипа. ")
                                                    addPrint("Указана причина: нельзя сохранять библиотеку в чип Duplicator")
                                                }
                                                else {
                                                    addPrintLibrary("Библиотека \"")
                                                    addPrintValue(Library_n)
                                                    addPrint("\" ")
                                                    addPrintGreen("готова ")
                                                    addPrint("к сохранению.")
                                                    addPrintDuplicator("Библиотека будет записана в этот чип.")
                                                    
                                                    local Code = ""
                                                    Code+= "@name " + Library_n
                                                    Code+= "\n"
                                                    Code+= "@outputs [VonLibrary]:string"
                                                    Code+= "\n"
                                                    Code+= "VonLibrary = getCode():explode(\"#vonCode#\")[3, string]"
                                                    Code+= "\n"
                                                    Code+= "#vonCode#" + vonEncode(GLibrary:toTable())
                                                    E2:remoteSetCode(Code)
                                                    
                                                    local VonError = vonError()
                                                    if(VonError) {
                                                        addPrintDuplicator("")
                                                        addPrintRed("[ОШИБКА] ")
                                                        addPrint(vec(200), "vonError: " + VonError)
                                                    }
                                                }
                                            }
                                            else {
                                                addPrintDuplicator("")
                                                addPrintRed("Ошибка сохранения библиотеки путём замены кода чипа. ")
                                                addPrint("Указана причина: вы не являетесь владельцем чипа.")
                                            }
                                    #else
                                        addPrintDuplicator("")
                                        addPrintRed("Ошибка сохранения библиотеки путём замены кода чипа. ")
                                        addPrint("Указана причина: отсутствует функция ")
                                        addPrintRemoteSetCode()
                                    #endif
                                }
                                elseif(!E2) {
                                    addPrintDuplicator("")
                                    addPrintRed("Ошибка сохранения библиотеки путём замены кода чипа. ")
                                    addPrint("Вы не выбрали чип для замены его кода, вы смотрите в пустоты.")
                                }
                                else {
                                    addPrintDuplicator("")
                                    addPrintRed("Ошибка сохранения библиотеки путём замены кода чипа. ")
                                    addPrint("Указана причина: этот объект не является чипом E2.")
                                }
                                break
                            }
                            addPrintLibrary("Библиотека \"")
                            addPrintValue(Library_n)
                            addPrint("\" ")
                            addPrintGreen("готова ")
                            addPrint("к сохранению.")
                            addPrintFile("Начинаю процедуру сохранения библиотеки.")
                            
                            Duplicator["fileSistem/procedure", string] = "librarySave"
                        }
                        else {
                            addPrintDuplicator("")
                            addPrintRed("Ошибка сохранения библиотеки. ")
                            addPrint("Указана причина: нет загруженной библиотеки. Воспользуйтесь командой \"")
                            addPrintBlue("!создать")
                            addPrint("\", или командой \"")
                            addPrintBlue("!загрузить библиотеку")
                            addPrint("\".")
                        }
                    break
                    #
                    #
                    default,
                        addPrintDuplicator("Сохранить что?")
                    break
                }
            break
            #
            #
            #
            case "загрузить",
                
            break
            #
            #
            #
            default,
                if(Duplicator["commadSistem/" + Command, number]) {
                    addPrintDuplicator("Этой команде нет назначенного действия, возможно, она еще на стадии разработки.")
                }
                else {
                    addPrintDuplicator("Этой команды не сущетствует. Для просмотра спика команд воспользуйтесь командой \"")
                    addPrintBlue("!команды")
                    addPrint("\"")
                }
            break
        }
    }
}

if(clk("updaterSistem") | httpClk()) {
    local Procedure = Duplicator["updaterSistem/procedure", string]
        timer("updaterSistem", Procedure ? 150 : 500)
    
    if(changed(0)) {
        Duplicator["updaterSistem/url", string] = "https://raw.githubusercontent.com/AncRad/expression/master/Duplicator"
    }
    
    switch(Procedure) {
        case "request",
            
            if(httpCanRequest()) {
                addPrintUpdater("Запрос на загрузку файла отправлен")
                httpRequest(Duplicator["updaterSistem/url", string])
                
                Duplicator["updaterSistem/procedure", string] = "wait"
                Duplicator["updaterSistem/request/startTime", number] = 0
                break
            }
            if(Duplicator["updaterSistem/request/startTime", number]) {
                if((curtime() - Duplicator["updaterSistem/request/startTime", number]) >= Duplicator["updaterSistem/request/maxTime", number]) {
                    addPrintUpdater("")
                    addPrintRed("Ошибка загрузки!")
                    addPrint("Указана причина: вышло время ожидания разрешения на запрос файла (")
                    addPrintValue(Duplicator["updaterSistem/request/maxTime", number] + "с")
                    addPrint(")")
                    addPrintUpdater("Вы можете загрузить файл самостоятельно, перейдя по ссылке ")
                    addPrintValue(Duplicator["updaterSistem/url", string])
                    
                    Duplicator["updaterSistem/procedure", string] = ""
                    Duplicator["updaterSistem/request/startTime", number] = 0
                }
            }
            else {
                addPrintUpdater("Ожидается разрешение на запрос файла")
                Duplicator["updaterSistem/request/startTime", number] = curtime()
            }
        break
        #
        #
        #
        case "wait",
            
            if(httpClk()) {
                local Data = httpData()
                
                if(Data) {
                    
                    addPrintUpdater("Файл получен. Ваша версия кода ")
                    Duplicator["updaterSistem/data", string] = Data
                    if(getCode() == Data) {
                        addPrintGreen("не отличается")
                        addPrint(" от последней оригинальной версии кода.")
                    }
                    else {
                        addPrintRed("отличается")
                        addPrint(" от последней оригинальной версии кода. ")
                        addPrint("Вы можете воспользоваться командой \"")
                        addPrintBlue("!обновить")
                        addPrint("\"")
                    }
                    Duplicator["updaterSistem/update", string] = Data
                }
                else {
                    addPrintUpdater("")
                    addPrintRed("Ошибка загрузки! ")
                    addPrint("Указана причина: файл пуст")
                    addPrintUpdater("Вы можете загрузить файл самостоятельно, перейдя по ссылке ")
                    addPrintValue(Duplicator["updaterSistem/url", string])
                }
                
                Duplicator["updaterSistem/procedure", string] = ""
                Duplicator["updaterSistem/wait/startTime", number] = 0
                break
            }
            if(Duplicator["updaterSistem/wait/startTime", number]) {
                if((curtime() - Duplicator["updaterSistem/wait/startTime", number]) >= Duplicator["updaterSistem/wait/maxTime", number]) {
                    
                    addPrintUpdater("")
                    addPrintRed("Ошибка загрузки! ")
                    addPrint("Указана причина: превышено время ожидания ответа сервера gitHub (")
                    addPrintValue(Duplicator["updaterSistem/wait/maxTime", number] + "с")
                    addPrint(")")
                    addPrintUpdater("Вы можете загрузить файл самостоятельно, перейдя по ссылке ")
                    addPrintValue(Duplicator["updaterSistem/url", string])
                    
                    Duplicator["updaterSistem/procedure", string] = ""
                    Duplicator["updaterSistem/wait/startTime", number] = 0
                }
            }
            else {
                Duplicator["updaterSistem/wait/startTime", number] = curtime()
            }
        break
        #
        #
        #
        default,
            
        break
    }
}

if(clk("fileSistem") | fileClk()) {
    local Procedure = Duplicator["fileSistem/procedure", string]
        timer("fileSistem", Procedure ? 150 : 500)
    
    switch(Procedure) {
        case "librarySave",
            
            if(fileCanWrite()) {
                local Library_n = GLibrary["library/name", string]
                addPrintFile("Библиотека \"")
                addPrintValue(Library_n)
                addPrint("\" сохранена ")
                addPrintGreen("удачно")
                addPrint(".")
                
                fileWrite("duplicator/" + Library_n + ".txt", vonEncode(GLibrary:toTable()))
                
                local VonError = vonError()
                if(VonError) {
                    addPrintDuplicator("")
                    addPrintRed("[ОШИБКА] ")
                    addPrint(vec(200), "vonError: " + VonError)
                }
                
                
                Duplicator["fileSistem/procedure", string] = ""
                Duplicator["fileSistem/write/startTime", number] = 0
                break
            }
            if(Duplicator["fileSistem/write/startTime", number]) {
                if((curtime() - Duplicator["fileSistem/write/startTime", number]) >= Duplicator["fileSistem/write/maxTime", number]) {
                    addPrintFile("")
                    addPrintRed("Ошибка сохранения библиотеки! ")
                    addPrint("Указана причина: привышено время ожидания разрешения на сохранение файла (")
                    addPrintValue(Duplicator["fileSistem/write/maxTime", number] + "с")
                    addPrint(")")
                    
                    #ifdef entity:remoteSetCode(string)
                        addPrintDuplicator("Воспользовавшись командой \"")
                        addPrintBlue("!сохранить библиотеку в этот чип")
                        addPrint("\", вы можете сохранить библиотеку, заменив код чипа, на который смотрите.")
                    #else 
                        addPrintDuplicator("Простите, но на данном этапе разработки дубликатора альтернативы не предусмотрены.")
                    #endif
                    
                    Duplicator["fileSistem/procedure", string] = ""
                    Duplicator["fileSistem/write/startTime", number] = 0
                }
            }
            else {
                addPrintFile("Ожидание разрешения на сохранение файла")
                Duplicator["fileSistem/write/startTime", number] = curtime()
            }
        break
        default,
            
        break
    }
}




























if(clk("printSistem")) {
        timer("printSistem", 350)
    
    local Print = Duplicator["printSistem/print", array]
    if(Print:count()) {
        printColor(Print)
        Duplicator["printSistem/print", array]:clear()
    }
}
setName("Duplicator\nOPS: " + ops() + "\nCPU: " + floor(cpuUsage() * 1e6))

